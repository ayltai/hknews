name: CI
on: [push]
jobs:
  check-java:
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v2
      - name: Set up JDK 14
        uses: actions/setup-java@v1
        with:
          java-version: 14
      - name: Run linters
        run: ./gradlew checkJava
      - name: Upload Checkstyle report
        uses: actions/upload-artifact@v2
        with:
          name: checkstyle-report
          path: build/reports/checkstyle/
      - name: Upload SpotBugs report
        uses: actions/upload-artifact@v2
        with:
          name: spotbugs-report
          path: build/reports/spotbugs/
  test-application:
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v2
      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 15
      - name: Run JavaScript unit tests
        run: ./gradlew testJavaScript
      - name: Upload JavaScript test coverage report
        uses: actions/upload-artifact@v2
        with:
          name: javascript-coverage-report
          path: coverage/
      - name: Set up JDK 14
        uses: actions/setup-java@v1
        with:
          java-version: 14
      - name: Run Java unit tests
        run: ./gradlew test
      - name: Upload Java tests report
        uses: actions/upload-artifact@v2
        with:
          name: java-test-report
          path: build/reports/tests/test/
      - name: Generate Java test coverage report
        run: ./gradlew jacocoTestReport
      - name: Upload Java test coverage report
        uses: actions/upload-artifact@v2
        with:
          name: java-coverage-report
          path: build/reports/jacoco/
      - name: Run SonarQube scanner
        run: ./gradlew sonarqube
        if: ${{ always() }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  check-terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v2
      - name: Set up JDK 14
        uses: actions/setup-java@v1
        with:
          java-version: 14
      - name: Create Terraform credentials file
        run: 'echo "$TF_CLI_CONFIG_FILE" > src/main/terraform/.terraformrc'
        env:
          TF_CLI_CONFIG_FILE: ${{ secrets.TF_CLI_CONFIG_FILE }}
      - name: Create Terraform variables file
        run: 'echo "$TERRAFORM_VARIABLES" > src/main/terraform/secrets.tfvars'
        env:
          TERRAFORM_VARIABLES: ${{ secrets.TERRAFORM_VARIABLES }}
      - name: Validate Terraform configurations
        run: ./gradlew checkTerraform
      - name: Plan for changes with Terraform configurations
        run: ./gradlew planTerraform
  test-ansible:
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v2
      - name: Set up JDK 14
        uses: actions/setup-java@v1
        with:
          java-version: 14
      - name: Set up Python 3
        uses: actions/setup-python@v2
        with:
          python-version: 3.x
      - name: Run Ansible unit tests
        run: ./gradlew testAnsible
