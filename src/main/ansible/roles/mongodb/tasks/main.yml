---
- name: Add MongoDB Community Edition repository
  yum_repository:
    name: "mongodb-{{ mongodb_version }}"
    description: "Official MongoDB {{ mongodb_version }} Community Edition repository"
    baseurl: "https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/{{ mongodb_version }}/x86_64/"
    gpgcheck: yes
    gpgkey: "https://www.mongodb.org/static/pgp/server-{{ mongodb_version }}.asc"
  when:
    - ansible_facts['os_family'] == 'RedHat'
    - ansible_facts['distribution'] != 'Fedora'

- name: Add MongoDB Community Edition repository
  yum_repository:
    name: "mongodb-{{ mongodb_version }}"
    description: "Official MongoDB {{ mongodb_version }} Community Edition repository"
    baseurl: "https://repo.mongodb.org/yum/redhat/8/mongodb-org/{{ mongodb_version }}/x86_64"
    gpgcheck: yes
    gpgkey: "https://www.mongodb.org/static/pgp/server-{{ mongodb_version }}.asc"
  when: ansible_facts['distribution'] == 'Fedora'

- block:
    - name: Install MongoDB Community Edition
      yum:
        name: mongodb-org
        update_cache: yes

    - name: Create data directory
      file:
        path: /data/db
        owner: root
        group: root
        mode: '0644'
        state: directory

    - name: Change binding IP address
      replace:
        path: /etc/mongod.conf
        regexp: '^bind_ip = 127.0.0.1$'
        replace: 'bind_ip = 0.0.0.0'

    - name: Enable MongoDB Community Edition service
      systemd:
        name: mongod
        state: started
        enabled: yes
  when: ansible_facts['os_family'] == 'RedHat'

- block:
    - name: Install MongoDB server
      apt:
        name: mongodb
        update_cache: yes

    - name: Create data directory
      file:
        path: /data/db
        owner: root
        group: root
        mode: '0644'
        state: directory

    - name: Change binding IP address
      replace:
        path: /etc/mongodb.conf
        regexp: '^bind_ip = 127.0.0.1$'
        replace: 'bind_ip = 0.0.0.0'

    - name: Enable MongoDB server service
      command: service mongodb start
  when: ansible_facts['os_family'] == 'Debian'
